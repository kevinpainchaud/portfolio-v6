name: Build and publish website

on:
    push:
        branches:
            - release/**
            - master

jobs:
    Build-and-publish-website:
        name: Build-and-publish-website
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@master
            - name: Use Node.js 12.x
              uses: actions/setup-node@v1
              with:
                  node-version: "12.x"
            - name: Build project
              run: |
                  npm ci
                  npm run build
            - name: List output files
              run: |
                  cd ./dist
                  ls
            - name: Determine distant target directory (pre-production or production)
              run: |
                  export TARGET_ENV="$([ "$GITHUB_REF" == 'refs/heads/master' ] && echo "production" || echo "pre-production")"
                  echo "::set-env name=TARGET_ENV::$TARGET_ENV"
                  echo "Target env: $TARGET_ENV"
                  export DIST_TARGET_DIR="$([ "$TARGET_ENV" == 'production' ] && echo ${{ secrets.DIST_TARGET_DIR_PROD }} || echo ${{ secrets.DIST_TARGET_DIR_PREPROD }})"
                  echo "::set-env name=DIST_TARGET_DIR::$DIST_TARGET_DIR"
            - name: Deploy to FTP (${{ env.TARGET_ENV }})
              uses: kevinpainchaud/simple-ftp-deploy-action@v1
              with:
                  ftp_host: ${{ secrets.FTP_HOST }}
                  ftp_username: ${{ secrets.FTP_USERNAME }}
                  ftp_password: ${{ secrets.FTP_PASSWORD }}
                  local_source_dir: dist
                  dist_target_dir: ${{ env.DIST_TARGET_DIR }}
                  delete: "true"
